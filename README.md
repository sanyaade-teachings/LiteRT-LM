# LiteRT LM
GitHub repository for Google's open-source high-performance runtime for
on-device LLM.

## How to build and run

`bazel` is used as the build system. Install `bazel` via
[Bazelisk](https://github.com/bazelbuild/bazelisk) or follow the
[instructions](https://bazel.build/install) per platform.

### Linux

`clang` is used to build LiteRT LM on linux. Build `litert_lm_main`, a CLI
executable and run models on CPU.

```
# Build litert_lm_main.
bazel build //runtime/engine:litert_lm_main

# Run litert_lm_main with a model .litertlm file.
bazel-bin/runtime/engine/litert_lm_main \
    --backend=cpu \
    --model_path=<model .litertlm file>
```

### Android

Install NDK r28b or newer from https://developer.android.com/ndk/downloads.
To run on CPU, only `litert_lm_main` is required.

```
# Define ANDROID_NDK_HOME used by bazel.
export ANDROID_NDK_HOME=<ndk dir>

# Build litert_lm_main for android_arm64 target.
bazel build --config=android_arm64 //runtime/engine:litert_lm_main

# Push litert_lm_main and a model .litertlm file to target device.
adb push bazel-bin/runtime/engine/litert_lm_main /data/local/tmp
adb push <model .litertlm file> /data/local/tmp

# Run litert_lm_main with a model .litertlm file on target device.
adb shell /data/local/tmp/litert_lm_main \
    --backend=cpu \
    --model_path=<model .litertlm file>
```

To run on GPU, `libLiteRtGpuAccelerator.so` and `libLiteRtTopKOpenClSampler.so`
are required which are prebuilt under `prebuilt/android_arm64`.

```
# Follow instructions above to push litert_lm_main and a model .litertlm file to
# target device.

# Push shared libraries for GPU to target device.
adb push prebuilt/android_arm64/*.so /data/local/tmp

# Run litert_lm_main with a model .litertlm file on GPU on target device.
adb shell LD_LIBRARY_PATH=/data/local/tmp \
    /data/local/tmp/litert_lm_main \
    --backend=gpu \
    --model_path=<model .litertlm file>
```

To run on Qualcomm NPU, `libLiteRtDispatch_Qualcomm.so` and
`libLiteRtDispatch_Qualcomm.so` built from source and Qualcomm's runtime shared
libraries downloaded from [TBD]()
are required.

```
# Follow instructions above to push litert_lm_main to target device.

# Build shared libraries for Qualcomm NPU for android_arm64 target.
bazel build --config=android_arm64 \
    @litert//litert/vendors/qualcomm/dispatch:dispatch_api_so \
    @litert//litert/vendors/qualcomm/compiler:qnn_compiler_plugin_so

# Push shared libraries for Qualcomm NPU to target device.
adb push bazel-bin/external/litert/litert/vendors/qualcomm/*/*.so \
    /data/local/tmp

# Push Qualcomm NPU runtime shared libraries distributed by Qualcomm.
adb push <qualcomm runtime shlibs> /data/local/tmp

# Push model .tflite files generated by Qualcomm NPU compiler to target device.
# Note that Qualcomm NPU runtime takes .tflite file instead of .litertlm file.
adb push <model .tflite file> /data/local/tmp

# Run litert_lm_main with a main model .litertlm file on Qualcomm NPU on target
# device.
adb shell LD_LIBRARY_PATH=/data/local/tmp \
    /data/local/tmp/litert_lm_main \
    --backend=qnn \
    --model_path=<model .tflite file>
```

### MacOS

Xcode command line tools include clang. Run `xcode-select --install` if not
installed before.

```
# Build litert_lm_main on MacOS.
bazel build //runtime/engine:litert_lm_main

# Run litert_lm_main with a model .litertlm file on MacOS.
bazel-bin/runtime/engine/litert_lm_main \
    --backend=cpu \
    --model_path=<model .litertlm file>
```

If bazel can't figure out the right version of MacOS SDK, append
`--macos_sdk_version=<sdk version>` in `bazel build`.

```
# Search for MacOS SDK version.
xcrun --sdk macosx --show-sdk-version

# Build litert_lm_main with a correct MacOS SDK version.
bazel build --macos_sdk_version=<sdk version> //runtime/engine:litert_lm_main
```
